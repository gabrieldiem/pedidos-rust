[![Review Assignment Due Date](https://classroom.github.com/assets/deadline-readme-button-22041afd0340ce965d47ae6ef1cefeee28c7c493a6346c4f15d667ab976d596c.svg)](https://classroom.github.com/a/YmMajyCa)

Para informaci√≥n sobre setup del proyecto ver el documento [`./docs/contribute.md`](./docs/contribute.md).

---

# PedidosRust - Grupo MutexMasters

<p align="center">
    <img src="./docs/imgs/pedidos_rust_logo.png" alt="PedidosRust logo" height="300px">
</p>

PedidosRust es una nueva aplicaci√≥n para conectar restaurantes, repartidores y comensales. Gracias a su innovadora implementaci√≥n distribuida, permitir√° reducir los costos y apuntar a ser l√≠der en el mercado.

Los comensales podr√°n solicitar un pedido a un restaurante, los restaurantes notifican cuando el pedido est√° listo, y los repartidores buscan pedidos cercanos y los entregan.

### Integrantes

| Nombre                            | Padr√≥n | Email              |
| --------------------              | ------ | -----------------  |
| Avalos, Victoria                  | 108434 | vavalos@fi.uba.ar  |
| Chac√≥n, Ignacio                   | 108298 | ichacons@fi.uba.ar |
| Diem, Walter Gabriel              | 105618 | wdiem@fi.uba.ar    |
| Funes Cabanelas, Nicol√°s Ezequiel | 109830 | nfunes@fi.uba.ar   |

---

### Table of contents

1. [Aplicaciones](#Aplicaciones)
1. [Estructura del repositorio y sistema](#Estructura-del-repositorio-y-sistema)
1. [Uso](#Uso)
1. [Dise√±o](#Dise√±o)
   1. [Pedidos-rust](#Pedidos-rust)
   1. [Customer](#Customer)
   1. [Rider](#Rider)
   1. [Restaurant](#Restaurant)
   1. [Payment](#Payment)
1. [Mensajes](#Mensajes)
1. [Resiliencia distribuida](#Resiliencia-distribuida)

## Aplicaciones

Hay 5 aplicaciones ejecutables, las cuales son referenciados por sus nombres en ingl√©s (por consistencia con la convenci√≥n de programaci√≥n):

- Requeridas por la consigna (4 apps): comensales (`customers`), restaurantes (`restaurants`), repartidores (`riders`), gateway de pagos (`payment`).

- Adicional (1 app): aplicaci√≥n para simplificar el manejo de mensajes entre actores llamada `pedidos-rust`.

## Estructura del repositorio y sistema

El root del repositorio es un workspace que contiene los proyectos (ejecutables binarios separados, cada uno con su `Cargo.toml`) y el c√≥digo en com√∫n:

```
.
‚îú‚îÄ‚îÄ common          C√≥digo compartido entre aplicaciones y protocolo
‚îú‚îÄ‚îÄ customer        Project del customer
‚îú‚îÄ‚îÄ docs
‚îú‚îÄ‚îÄ payment         Project del payment gateway
‚îú‚îÄ‚îÄ pedidos-rust    Project del pedidos-rust
‚îú‚îÄ‚îÄ restaurant      Project del restaurant
‚îú‚îÄ‚îÄ rider           Project del rider
‚îî‚îÄ‚îÄ Cargo.toml      Configuraci√≥n del workspace
```

## Uso

Se deja las instrucciones para ejecutar las diversas apps:

**Customer:**

```bash
cargo run -p customer
```

**Payment:**

```bash
cargo run -p payment
```

**Pedidos-rust:**

```bash
cargo run -p pedidos-rust
```

**Restaurant:**

```bash
cargo run -p restaurant
```

**Rider:**

```bash
cargo run -p rider
```

---

## Dise√±o

### <ins>Application level</ins>

<p align="center">
    <img src="./docs/imgs/c4_app_level.png" alt="PedidosRust logo" height="800px">
</p>

### <ins>Pedidos-rust</ins>

#### Finalidad

Aplicaci√≥n que es un servidor distribuido que recibe pedidos de los customers, autoriza los pagos con el payment gateway, coordina con los restaurantes la preparaci√≥n del pedido y una vez listo le ofrece los pedidos a los riders para que realicen el delivery y le da la asignaci√≥n final al que acepte primero, mantiene actualizado al customer del estado del pedido en todo momento y efectiviza el cobro del pedido una vez se confirma que el delivery fue entregado al customer.

#### Estado interno

La estructura de la app consta de una entidad `Server` que es due√±a del welcomming socket de TCP (usado de manera as√≠ncrona para recibir conexiones), por cada conexi√≥n recibida de tiene un actor `ClientConnection` y estos pueden solicitar funcionalidades que requieren visibilidad de todas las conexiones del actor `ConnectionManager`. Todo el modelado de actores apalanca los handlers as√≠ncronos para la concurrencia.

<p align="center">
    <img src="./docs/imgs/pedidos_rust_app.png" alt="pedidos_rust_app" height="500px">
</p>

En una situaci√≥n donde hay s√≥lo 1 customer y 1 rider conectados al PedidosRust, los actores presentes ser√≠an:

<p align="center">
    <img src="./docs/imgs/pedidos_rust_app_1_customer_1_rider.png" alt="pedidos_rust_app_1_customer_1_rider" height="400px">
</p>

**Variables internas de `Server`:**

```rust
pub struct Server {
    logger: Logger,
    connection_manager: Addr<ConnectionManager>,
}
```

**Variables internas de `ClientConnection`:**

```rust
pub struct ClientConnection {
    pub tcp_sender: Addr<TcpSender>,
    pub logger: Logger,
    pub id: u32,
    pub connection_manager: Addr<ConnectionManager>,
    pub peer_location: Option<Location>,
}
```

**Variables internas de `ConnectionManager`:**

```rust
pub struct ConnectionManager {
    pub logger: Logger,
    pub riders: HashMap<RiderId, Addr<ClientConnection>>,
    pub customers: HashMap<CustomerId, CustomerData>,
    pub orders_in_process: HashMap<RiderId, CustomerId>,
    pub pending_delivery_requests: VecDeque<Message>,
}
```

### <ins>Customer</ins>

#### Finalidad

Aplicaci√≥n que utiliza el customer para poder consultar los restaurantes donde puede hacer un pedido, elegir un restaurante para realizarle un pedido y recibir notificaciones (push notifications) de c√≥mo progresa el pedido a medida que se avanza en el proceso de delivery.

Proceso de delivery:

1. Pago autorizado
1. Restaurante est√° preparando el pedido
1. Pedido est√° listo
1. Rider 1234 est√° llevando el pedido
1. Pedido entregado

#### Estado interno

Est√° modelado como un actor con handlers as√≠ncronos para manejar la concurrencia. Utiliza TCP para la comunicaci√≥n por la red.

**Variables internas de `Customer`:**

```rust
struct Customer {
    tcp_sender: Addr<TcpSender>,
    logger: Logger,
    location: Location,
}
```

### <ins>Rider</ins>

#### Finalidad

Aplicaci√≥n que utiliza el rider para actualizar su ubicaci√≥n al PedidosRust, recibir ofertas de deliveries (se le dice _oferta_ porque PedidosRust ofrece a los riders la posibilidad de realizar un delivery, el rider puede aceptar o no, y PedidosRust confirma si el rider fue elegido como el que efectivamente va a realizar el env√≠o), ir a retirar el pedido del restaurante para llevarle al customer, y viajar hasta la ubicaci√≥n del customer para realizar la entrega del pedido.

#### Estado interno

Est√° modelado como un actor con handlers as√≠ncronos para manejar la concurrencia. Utiliza TCP para la comunicaci√≥n por la red.

**Variables internas de `Rider`:**

```rust
struct Rider {
    tcp_sender: Addr<TcpSender>,
    logger: Logger,
    location: Location,
    customer_location: Option<Location>,
    busy: bool,
}
```

### <ins>Restaurant</ins>

#### Finalidad

Aplicaci√≥n que utilizan los restaurantes para recibir pedidos de los comensales, notificar cuando los comienza a preparar y cuando el pedido est√° listo para ser retirado por el rider. El restaurante puede cancelar un pedido por falta de stock con una probabilidad aleatoria del 10% (simulando que el stock se agota en el momento de la preparaci√≥n).

#### Estado interno

Est√° modelado con tareas as√≠ncronas de tokio para manejar los pedidos concurrentemente, asignando cada pedido a una tarea as√≠ncrona.
Se comunica con PedidosRust mediante TCP para recibir los pedidos y contestar.

**Variables internas de `Restaurant`:**

```rust
struct Payment {
    tcp_sender: Addr<TcpSender>,
    location: Location
}
```

### <ins>Payment</ins>

#### Finalidad

Aplicaci√≥n que autoriza y efectiviza un cobro. El flujo de un pago consta de dos fases secuenciales: primero se autoriza el pago y luego se efectiviza el cobro. La primera fase (la autorizaci√≥n del pago) puede fallar debido a un rechazo. Pero la efectivizaci√≥n del mismo (debitar el dinero) se realiza sin posibilidad de falla.

Se entiende al payment gateway como un servicio externo de terceros, como podr√≠a ser Visa o MasterCard.

#### Estado interno

Est√° modelado con tareas as√≠ncronas para manejar la concurrencia. Utiliza TCP para la comunicaci√≥n por la red.

**Variables internas de `Payment`:**

```rust
struct Payment {
    tcp_sender: Addr<TcpSender>,
    logger: Logger,
}
```

## Mensajes

Se muestra a continuaci√≥n un diagrama de secuencia que representa el flujo de mensajes entre las aplicaciones en un caso de uso exitoso donde un cliente realiza un pedido a un restaurante.

<p align="center">
    <img src="./docs/imgs/caso_feliz.png" alt="Diagrama de Secuencia" height="700px">
</p>

Se presentan los mensajes que intercambian las aplicaciones para poder llevar a cabo el env√≠o de pedidos de manera efectiva y resiliente:

| Mensaje                   | Emisor                 | Receptor               | Payload                                                              | Prop√≥sito                                                                                                           |
|---------------------------| ---------------------- | ---------------------- |----------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------|
| Get Restaurants           | Customerüë®üèª‚Äçü¶±             | PedidosRustü¶Ä          | `customer_location: Location` (`Location` son dos enteros `x` e `y`) | Solicitar restaurantes para realizar un pedido                                                                      |
| Restaurants               | PedidosRustü¶Ä          | Customerüë®üèª‚Äçü¶±             | `data: String`                                                       | Comunicar los restaurantes disponibles                                                                              |
| Order                     | Customerüë®üèª‚Äçü¶±             | PedidosRustü¶Ä          | `restaurant: String, amount: f64`                                    | Realizar un pedido                                                                                                  |
| Push Notification         | PedidosRustü¶Ä          | Customerüë®üèª‚Äçü¶±             | `notification_msg: String`                                           | Env√≠o de informaci√≥n para seguimiento en tiempo real del estado del pedido                                          |
| Location Update           | Riderüõµ                | PedidosRustü¶Ä          | `new_location: Location`                                             | Informar nueva ubicaci√≥n                                                                                            |
| Delivery Offer            | PedidosRustü¶Ä          | Riderüõµ                | `customer_id: u32, customer_location: Location`                      | Ofrecer un pedido al rider que puede aceptar o no                                                                   |
| Delivery Offer Accepted   | Riderüõµ                | PedidosRustü¶Ä          | `customer_id: u32, customer_location: Location`                      | Aceptar el ofrecimiento de pedido                                                                                   |
| Delivery Offer Confirmed  | PedidosRustü¶Ä          | Riderüõµ                | `customer_id: u32, customer_location: Location`                      | Confirmar que el rider es el elegido para hacer el delivery                                                         |
| Picked Up From Restaurant | Riderüõµ                | PedidosRustü¶Ä          | `rider_id: u32`                                                      | Informar que el rider ya hizo el retiro de la orden del restaurante                                                 |
| Delivery Done             | Riderüõµ                | PedidosRustü¶Ä          | `rider_id: u32`                                                      | Informar que el rider lleg√≥ a la ubicaci√≥n del customer y entreg√≥ el pedido                                         |
| Finish Delivery           | PedidosRustü¶Ä          | Customerüë®üèª‚Äçü¶±             |                                                                      | Realizar √∫ltima actualizaci√≥n del pedido para marcar que se complet√≥ el mismo, y que el cliente pueda realizar otro |
| Authorize Payment         | PedidosRustü¶Ä          | Payment üí≤             | `customer_id: u32, amount: f64`                                      | Solicitar la autorizaci√≥n del pago                                                                                  |
| Payment Authorized        | Payment üí≤             | PedidosRustü¶Ä          | `customer_id: u32, amount: f64`                                      | Informar que el pago se autoriz√≥ exitosamente                                                                       |
| Payment Denied            | Payment üí≤             | PedidosRustü¶Ä          | `customer_id: u32, amount: f64`                                      | Informar que el pago no se pudo autorizar                                                                           |
| Execute Payment           | PedidosRustü¶Ä          | Payment üí≤             | `customer_id: u32, amount: f64`                                      | Debitar/efectivizar el pago                                                                                         |
| Payment Executed          | Payment üí≤             | PedidosRustü¶Ä          | `customer_id: u32, amount: f64`                                      | Informar que el d√©bito del pago fue exitoso                                                                         |
 Order In Progress         | Restaurantüç¥           | PedidosRustü¶Ä          | `customer_id: u32`                                                   | Comenzar a preparar orden                                                                                           |
| Prepare Order             | PedidosRustü¶Ä          | Restaurantüç¥           | `customer_id: u32, price: u64`                                       | Preparar orden para un customer                                                                                     |
| Order In Progress         | Restaurantüç¥           | PedidosRustü¶Ä          | `customer_id: u32`                                                   | Comenzar a preparar orden                                                                                           |
| Inform Location           | Restaurantüç¥           | PedidosRustü¶Ä          | `restaurant_location: Location`                                      | Informar su posici√≥n a PedidosRust                                                                                  |
| Order Ready               | Restaurantüç¥           | PedidosRustü¶Ä          | `customer_id: u32`                                                   | Informar que la orden est√° lista para ser retirada                                                                  |
| Rider Assigned            | PedidosRustü¶Ä          | Restaurantüç¥           | `rider_id: u32`                                                      | Informar que el rider con ID prove√≠da se encargar√° del env√≠o                                                        |
| Ping Request              | PedidosRustü¶Ä          | Restaurantüç¥ √≥ Riderüõµ |                                                                      | Consultar si el servicio est√° on-line mediante UDP                                                                  |
| Ping Response             | Restaurantüç¥ √≥ Riderüõµ | PedidosRustü¶Ä          |                                                                      | Informar mediante UDP que el servicio s√≠ est√° on-line                                                               |

A nivel actores, todos poseen un automensaje `Start`, que se env√≠a al comienzo de su ejecuci√≥n, y `Stop` para marcar la finalizaci√≥n de su ejecuci√≥n.

## Resiliencia distribuida

En primer lugar, PedidosRust contar√° con r√©plicas del proceso original que estar√°n a la espera de que el proceso **coordinador** deje de poder responder a peticiones externas. Cuanto esto pase, se llamar√° a elecciones internas mediante un *algoritmo de elecci√≥n distribuido* de tipo *bully* entre las r√©plicas para decidir el pr√≥ximo coordinador.

Por otro lado, con el objetivo de garantizar la integridad de datos entre las r√©plicas de `PedidosRust`, se implementar√° un algoritmo de tipo *ring* para el pasaje de datos entre las r√©plicas.

<p align="center">
    <img src="./docs/imgs/algos_distribuidos.jpeg" alt="algos_distribuidos" height="500px">
</p>